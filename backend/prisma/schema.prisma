datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Plan {
  FREE
  PREMIUM
}

enum LocationTag {
  FAVORITE
  HOME
}

enum RuleScope {
  ACTIVE
  HOME
}

enum RuleType {
  TEMP_GT
  WIND_GT
}

// NEW
enum PresenceMode {
  unknown
  indoor
  outdoor
  transit
}

// NEW
enum UserLocationType {
  current
  favorite
  home
  point
  city
}

model User {
  id           Int       @id @default(autoincrement())
  telegramId   String    @unique
  username     String?
  firstName    String?
  languageCode String    @default("ru")

  // NEW: расширенные настройки
  presenceMode   PresenceMode @default(unknown)
  summaryEnabled Boolean      @default(true)
  hazardsEnabled Boolean      @default(true)
  workStart      String       @default("09:00")
  workEnd        String       @default("18:00")

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  subscription Subscription?
  state        UserState?
  favorites    FavoriteLocation[]
  rules        AlertRule[]
  logs         NotificationLog[]

  // NEW relations
  locations    UserLocation[]
  plans        UserPlan[]
  alertEvents  AlertEvent[]
}

model Subscription {
  id        Int       @id @default(autoincrement())
  userId    Int       @unique
  plan      Plan      @default(FREE)
  validTill DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserState {
  id         Int      @id @default(autoincrement())
  userId     Int      @unique

  // legacy active location
  activeLat  Float?
  activeLon  Float?
  activeName String?

  // NEW: нормальная активная локация
  activeLocationId Int?
  activeLocation   UserLocation? @relation(fields: [activeLocationId], references: [id], onDelete: SetNull)

  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FavoriteLocation {
  id        Int         @id @default(autoincrement())
  userId    Int
  tag       LocationTag @default(FAVORITE)
  name      String
  lat       Float
  lon       Float
  createdAt DateTime    @default(now())

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([userId, tag])
}

model AlertRule {
  id              Int       @id @default(autoincrement())
  userId          Int
  scope           RuleScope
  type            RuleType
  threshold       Float
  isEnabled       Boolean   @default(true)
  cooldownMinutes Int       @default(180)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isEnabled])
}

model NotificationLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  ruleId    Int
  dedupeKey String
  message   String
  sentAt    DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, ruleId, sentAt])
  @@unique([dedupeKey])
}

// ==========================================
// NEW MODELS
// ==========================================

model UserLocation {
  id        Int              @id @default(autoincrement())
  userId    Int
  type      UserLocationType @default(point)
  name      String
  lat       Float
  lon       Float
  timezone  String

  isPending Boolean          @default(false)

  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userStates UserState[]
  alertEvents AlertEvent[]

  @@index([userId, type])
  @@index([userId, isPending])
}

model UserPlan {
  id               Int      @id @default(autoincrement())
  userId           Int
  name             String
  enabled          Boolean  @default(true)
  minWindowMinutes Int      @default(60)
  configJson       Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, enabled])
}

model PlanTemplate {
  id                String   @id
  name              String
  description       String?
  defaultConfigJson Json
  version           Int      @default(1)
}

model AlertEvent {
  id         Int      @id @default(autoincrement())
  userId     Int
  locationId Int?
  kind       String
  subtype    String?
  severity   String?
  dedupeKey  String   @unique
  payload    Json?
  sentAt     DateTime @default(now())

  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  location   UserLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@index([userId, sentAt])
}
